<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt lịch tư vấn</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0072bc;
            --text: #1f2937;
            --muted: #6b7280;
            --border: #e5e7eb;
            --bg: #ffffff;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: 'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji';
            color: var(--text);
            background: #f8fafc;
        }
        .container { max-width: 880px; margin: 32px auto; padding: 0 16px; }
        h2 { margin: 0 0 8px; font-weight: 700; }
        .muted { color: var(--muted); font-size: 14px; }

        .steps-indicator { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 16px 0 20px; }
        .step-box { text-align: center; }
        .dot {
            width: 32px; height: 32px; border-radius: 50%;
            margin: 0 auto 6px; display: flex; align-items: center; justify-content: center;
            background: #e9ecef; color: #6c757d; font-weight: 700;
        }
        .dot.active { background: var(--primary); color: #fff; }
        .label { font-size: 12px; color: var(--muted); }

        .card { background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .step { display: none; }
        .step.active { display: block; }

        .form-group { margin-bottom: 14px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        select, input[type="text"], input[type="date"], button {
            font-family: inherit;
        }
        /* Lưới ô lựa chọn */
        .options-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        @media (min-width: 640px) { .options-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 920px) { .options-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        .option-card {
            border: 1px solid #cbd5e1; border-radius: 10px; padding: 12px; background: #fff; text-align: left;
            cursor: pointer; transition: border-color .15s ease, box-shadow .15s ease, background-color .15s ease;
        }
        .option-card:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,.04); }
        .option-card.active { border-color: var(--primary); background: rgba(0,114,188,.06); }
        .option-title { font-weight: 600; margin: 0 0 4px; }
        .option-sub { color: var(--muted); font-size: 13px; margin: 0; }

        .btn { cursor: pointer; padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-secondary { background: #94a3b8; color: #fff; }
        .btn-outline { background: #ffffff; color: var(--primary); border: 1px solid var(--primary); }
        .btn-outline:hover { background: rgba(0,114,188,0.06); }
        .btn:disabled { opacity: .6; cursor: not-allowed; }

        .row-actions { display: flex; gap: 10px; justify-content: space-between; align-items: center; }
        .right { display: flex; gap: 10px; }

        .error { color: #dc3545; font-size: 14px; margin-top: 6px; }
        .hidden { display: none !important; }

        ul.summary { margin: 8px 0 0; padding-left: 18px; }
        ul.summary li { margin-bottom: 4px; }

        /* Nút quay lại góc trái trên */
        .back-top { position: fixed; top: 16px; left: 16px; z-index: 1000; }
    </style>
    <!-- Đây chỉ là giao diện tĩnh; chưa tích hợp API -->
    <!-- Màu chủ đạo: #0072bc; Font: Open Sans -->
</head>
<body>
    <button class="back-top btn btn-outline" id="btnTopBack" type="button">← Quay lại</button>
    <div class="container">
        <h2>Đặt lịch tư vấn với chuyên gia</h2>
        <div class="muted">Hoàn thành từng bước để chuyển tới thanh toán.</div>

        <div class="steps-indicator">
            <div class="step-box">
                <div class="dot active" id="stepDot1">1</div>
                <div class="label">Chuyên gia</div>
            </div>
            <div class="step-box">
                <div class="dot" id="stepDot2">2</div>
                <div class="label">Ngày</div>
            </div>
            <div class="step-box">
                <div class="dot" id="stepDot3">3</div>
                <div class="label">Ca</div>
            </div>
            <div class="step-box">
                <div class="dot" id="stepDot4">4</div>
                <div class="label">Thanh toán</div>
            </div>
        </div>

        <form class="card" id="bookingForm" method="post" action="/advise/checkout/">
            {% csrf_token %}
            <input type="hidden" name="expert_id" id="inputExpertId" value="">
            <input type="hidden" name="date" id="inputDate" value="">
            <input type="hidden" name="slot" id="inputSlot" value="">
            
            <div id="step1" class="step active">
                <div class="form-group">
                    <label for="expertSelect">Chọn chuyên gia</label>
                    <div id="expertsGrid" class="options-grid">
                        {% for e in expert %}
                        <div class="option-card" data-value="{{ e.id }}">
                            <p class="option-title">{{ e.first_name }} {{ e.last_name }}</p>
                            {% if e.sub %}<p class="option-sub">{{ e.sub }}</p>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div id="expertError" class="error hidden"></div>
                </div>
                <div class="row-actions" style="justify-content: flex-end;">
                    <div class="right">
                        <button class="btn btn-primary" id="btnToStep2" disabled>Tiếp tục</button>
                    </div>
                </div>
            </div>

            <div id="step2" class="step">
                <div class="form-group">
                    <label for="dateSelect">Chọn ngày</label>
                    <div id="datesGrid" class="options-grid">
                        {#
                          Ví dụ server có thể render:
                          {% for d in date %}
                            <div class="option-card" data-value="{{ d.value }}">
                                <p class="option-title">{{ d.date }}</p>
                            </div>
                          {% endfor %}
                        #}
                    </div>
                    <div id="dateError" class="error hidden"></div>
                </div>
                <div class="row-actions">
                    <button class="btn btn-secondary" id="backToStep1">Quay lại</button>
                    <div class="right">
                        <button class="btn btn-primary" id="btnToStep3" disabled>Tiếp tục</button>
                    </div>
                </div>
            </div>

            <!-- Bước 3: Chọn ca (tĩnh, ô) -->
            <div id="step3" class="step">
                <div class="form-group">
                    <label for="slotSelect">Chọn ca</label>
                    <div id="slotsGrid" class="options-grid">
                        {#
                          Ví dụ server có thể render:
                          {% for s in slots %}
                            <div class="option-card" data-value="{{ s.value }}">
                                <p class="option-title">{{ s.label }}</p>
                            </div>
                          {% endfor %}
                        #}
                    </div>
                    <div id="slotError" class="error hidden"></div>
                </div>
                <div class="row-actions">
                    <button class="btn btn-secondary" id="backToStep2">Quay lại</button>
                    <div class="right">
                        <button class="btn btn-primary" id="btnToStep4" disabled>Tiếp tục</button>
                    </div>
                </div>
            </div>

            <!-- Bước 4: Xác nhận (tĩnh) -->
            <div id="step4" class="step">
                <div class="form-group">
                    <div class="muted">Vui lòng kiểm tra thông tin đặt lịch:</div>
                    <ul class="summary">
                        <li><strong>Chuyên gia:</strong> <span id="summaryExpert">-</span></li>
                        <li><strong>Ngày:</strong> <span id="summaryDate">-</span></li>
                        <li><strong>Ca:</strong> <span id="summarySlot">-</span></li>
                    </ul>
                </div>
                <div class="row-actions">
                    <button class="btn btn-secondary" id="backToStep3">Quay lại</button>
                    <div class="right">
                        <button class="btn btn-primary" id="btnPay" type="submit">Tiếp tục tới thanh toán</button>
                    </div>
                </div>
            </div>
        </form>

        <div id="globalError" class="error hidden" style="margin-top:12px;"></div>
    </div>

    <script>
        // Điều hướng bước (không lưu biến trạng thái)
        function setStep(step) {
            const steps = [
                document.getElementById('step1'),
                document.getElementById('step2'),
                document.getElementById('step3'),
                document.getElementById('step4')
            ];
            const dots = [
                document.getElementById('stepDot1'),
                document.getElementById('stepDot2'),
                document.getElementById('stepDot3'),
                document.getElementById('stepDot4')
            ];
            steps.forEach((s, i) => s.classList.toggle('active', i === step - 1));
            dots.forEach((d, i) => d.classList.toggle('active', i < step));
        }

        // Gắn sự kiện chọn ô
        function bindCards(containerId, onPick) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const cards = Array.from(container.querySelectorAll('.option-card'));
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    cards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    const value = card.getAttribute('data-value') || '';
                    const label = card.querySelector('.option-title')?.textContent || '';
                    onPick(value, label);
                });
            });
        }

            // Helpers: render động và gọi API
        function renderDates(dates) {
            const grid = document.getElementById('datesGrid');
            if (!Array.isArray(dates) || dates.length === 0) {
                grid.innerHTML = '<div class="muted" style="grid-column: 1/-1">Không có ngày khả dụng.</div>';
                document.getElementById('btnToStep3').disabled = true;
                return;
            }
            const html = dates.map(d => {
                try {
                    const dt = new Date(d + 'T00:00:00');
                    const label = dt.toLocaleDateString('vi-VN', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
                    return `<div class="option-card" data-value="${d}"><p class=\"option-title\">${label}</p></div>`;
                } catch {
                    return '';
                }
            }).join('');
            grid.innerHTML = html;
            // gắn click sau khi render
            bindCards('datesGrid', (value, label) => {
                document.getElementById('inputDate').value = value;
                document.getElementById('btnToStep3').disabled = !value;
                // reset slots khi đổi ngày
                document.getElementById('inputSlot').value = '';
                document.getElementById('btnToStep4').disabled = true;
                const expertId = document.getElementById('inputExpertId').value;
                if (expertId && value) {
                    loadSlots(expertId, value);
                }
            });
        }

        function renderSlots(slots) {
            const grid = document.getElementById('slotsGrid');
            if (!Array.isArray(slots) || slots.length === 0) {
                grid.innerHTML = '<div class="muted" style="grid-column: 1/-1">Không có ca cho ngày này.</div>';
                document.getElementById('btnToStep4').disabled = true;
                return;
            }
            const html = slots.map(s => {
                const label = s.label || '';
                const value = s.shift_id || '';
                return `<div class=\"option-card\" data-value=\"${value}\"><p class=\"option-title\">${label}</p></div>`;
            }).join('');
            grid.innerHTML = html;
            bindCards('slotsGrid', (value, label) => {
                document.getElementById('inputSlot').value = value;
                document.getElementById('btnToStep4').disabled = !value;
            });
        }

        async function loadDates(expertId) {
            const grid = document.getElementById('datesGrid');
            grid.innerHTML = '<div class="muted" style="grid-column: 1/-1">Đang tải ngày...</div>';
            try {
                const res = await fetch(`/advise/available-dates/?expert_id=${encodeURIComponent(expertId)}`);
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                renderDates(data.dates || []);
            } catch (e) {
                grid.innerHTML = '<div class="error" style="grid-column: 1/-1">Không tải được danh sách ngày.</div>';
            }
        }

        async function loadSlots(expertId, dateStr) {
            const grid = document.getElementById('slotsGrid');
            grid.innerHTML = '<div class="muted" style="grid-column: 1/-1">Đang tải ca...</div>';
            try {
                const url = `/advise/available-slots/?expert_id=${encodeURIComponent(expertId)}&date=${encodeURIComponent(dateStr)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();
                renderSlots(data.slots || []);
            } catch (e) {
                grid.innerHTML = '<div class="error" style="grid-column: 1/-1">Không tải được danh sách ca.</div>';
            }
        }

        // Bước 1 → 2
        bindCards('expertsGrid', (value, label) => {
            document.getElementById('inputExpertId').value = value;
            document.getElementById('btnToStep2').disabled = !value;
        });
        document.getElementById('btnToStep2').addEventListener('click', (e) => {
            e.preventDefault();
            // reset sau
            document.getElementById('inputDate').value = '';
            document.getElementById('inputSlot').value = '';
            document.getElementById('btnToStep3').disabled = true;
            document.getElementById('btnToStep4').disabled = true;
            setStep(2);
            const expertId = document.getElementById('inputExpertId').value;
            if (expertId) {
                loadDates(expertId);
            }
        });
        document.getElementById('backToStep1').addEventListener('click', (e) => { e.preventDefault(); setStep(1); });

        // Bước 2 → 3
        document.getElementById('btnToStep3').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('inputSlot').value = '';
            document.getElementById('btnToStep4').disabled = true;
            setStep(3);
            const expertId = document.getElementById('inputExpertId').value;
            const dateStr = document.getElementById('inputDate').value;
            if (expertId && dateStr) {
                loadSlots(expertId, dateStr);
            } else {
                document.getElementById('slotsGrid').innerHTML = '<div class="muted" style="grid-column: 1/-1">Vui lòng chọn ngày trước.</div>';
            }
        });
        document.getElementById('backToStep2').addEventListener('click', (e) => { e.preventDefault(); setStep(2); });

        // Bước 3 → 4
        bindCards('slotsGrid', (value, label) => {
            document.getElementById('inputSlot').value = value;
            document.getElementById('btnToStep4').disabled = !value;
        });
        document.getElementById('btnToStep4').addEventListener('click', (e) => {
            e.preventDefault();
            // Cập nhật tóm tắt từ các ô đã chọn
            const expertLabel = document.querySelector('#expertsGrid .option-card.active .option-title')?.textContent || '-';
            const dateLabel = document.querySelector('#datesGrid .option-card.active .option-title')?.textContent || '-';
            const slotLabel = document.querySelector('#slotsGrid .option-card.active .option-title')?.textContent || '-';
            document.getElementById('summaryExpert').textContent = expertLabel;
            document.getElementById('summaryDate').textContent = dateLabel;
            document.getElementById('summarySlot').textContent = slotLabel;
            setStep(4);
        });
        document.getElementById('backToStep3').addEventListener('click', (e) => { e.preventDefault(); setStep(3); });

        // Nút quay lại góc trái trên: về trang chủ
        document.getElementById('btnTopBack').addEventListener('click', () => { window.location.href = '/'; });
    </script>
</body>
</html>
